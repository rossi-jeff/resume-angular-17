import {
  Component,
  Inject,
  Output,
  PLATFORM_ID,
  signal,
  EventEmitter,
} from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';
import { FormControl, FormGroup, ReactiveFormsModule } from '@angular/forms';
import {
  ContactFormType,
  ContactType,
  blankContact,
} from '../../types/contact.type';
import { FormatName } from '../../lib/format-name';
import { FormatAddress } from '../../lib/format-address';

@Component({
  selector: 'app-contact-stepper',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './contact-stepper.component.html',
  styleUrl: './contact-stepper.component.css',
})
export class ContactStepperComponent {
  @Output() send = new EventEmitter<ContactFormType>();
  steps: string[] = ['Name', 'Address', 'Contact', 'Message', 'Confirmation'];
  current: number = 0;
  contactForm = new FormGroup({
    Name: new FormGroup({
      Salutation: new FormControl(''),
      First: new FormControl(''),
      Middle: new FormControl(''),
      Last: new FormControl(''),
      Suffix: new FormControl(''),
    }),
    Address: new FormGroup({
      Address: new FormControl(''),
      Suite: new FormControl(''),
      City: new FormControl(''),
      State: new FormControl(''),
      Zip: new FormControl(''),
    }),
    Email: new FormControl(''),
    EmailType: new FormControl('Work'),
    Phone: new FormControl(''),
    PhoneType: new FormControl('Work'),
    Preferred: new FormControl('Email'),
    Subject: new FormControl(''),
    Message: new FormControl(''),
  });
  name: string = '';
  address: string = '';
  ready = signal(false);

  constructor(@Inject(PLATFORM_ID) private platformId: Object) {}

  nextStep = () => {
    if (this.current + 1 >= this.steps.length) return;
    this.current++;
    this.updateSteps();
  };

  previousStep = () => {
    if (this.current - 1 < 0) return;
    this.current--;
    this.updateSteps();
  };

  updateSteps = () => {
    if (isPlatformBrowser(this.platformId)) {
      for (let i = 0; i < this.steps.length; i++) {
        const btn = document.getElementById(
          `step-button-${i}`
        ) as HTMLButtonElement;
        const step = document.getElementById(`step-${i}`);
        if (i <= this.current) {
          btn.disabled = false;
        } else {
          btn.disabled = true;
        }
        if (i == this.current) {
          btn.classList.add('current');
          if (step) step.classList.add('current');
        } else {
          btn.classList.remove('current');
          if (step) step.classList.remove('current');
        }
      }
      this.updateContact();
      const btn = document.getElementById(
        'send-contact-button'
      ) as HTMLButtonElement;
      if (this.ready()) {
        btn.disabled = false;
      } else {
        btn.disabled = true;
      }
    }
  };

  updateContact = () => {
    const value = this.contactForm.value;
    const updates: ContactType = blankContact;
    if (value.Name) {
      updates.Name.First = value.Name.First || '';
      updates.Name.Last = value.Name.Last || '';
      updates.Name.Middle = value.Name.Middle || '';
      updates.Name.Salutation = value.Name.Salutation || '';
      updates.Name.Suffix = value.Name.Suffix || '';
    }
    this.name = FormatName(updates.Name);
    if (value.Address) {
      updates.Address.Address = value.Address.Address || '';
      updates.Address.City = value.Address.City || '';
      updates.Address.State = value.Address.State || '';
      updates.Address.Suite = value.Address.Suite || '';
      updates.Address.Zip = value.Address.Zip || '';
    }
    this.address = FormatAddress(updates.Address);
    updates.Email = value.Email || '';
    updates.EmailType = value.EmailType || blankContact.EmailType;
    updates.Message = value.Message || '';
    updates.Phone = value.Phone || '';
    updates.PhoneType = value.PhoneType || blankContact.PhoneType;
    updates.Preferred = value.Preferred || blankContact.Preferred;
    updates.Subject = value.Subject || '';

    if (this.name && (updates.Email || updates.Phone) && updates.Message) {
      this.ready.set(true);
    } else this.ready.set(false);
  };

  sendContact = () => {
    this.send.emit(this.contactForm.value);
  };

  goToStep = (idx: number) => {
    this.current = idx;
    this.updateSteps();
  };
}
